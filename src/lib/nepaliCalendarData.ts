export const calendarData = {
  bsMonths: [
    "बैशाख",
    "जेठ",
    "आषाढ",
    "श्रावण",
    "भदौ",
    "असोज",
    "कार्तिक",
    "मंसिर",
    "पौष",
    "माघ",
    "फाल्गुन",
    "चैत्र",
  ],
  bsMonthsEn: [
    "Baisakh",
    "Jestha",
    "Asar",
    "Shrawan",
    "Bhadra",
    "Asoj",
    "Kartik",
    "Mangsir",
    "Poush",
    "Magh",
    "Falgun",
    "Chaitra",
  ],
  bsDays: ["आईत", "सोम", "मंगल", "बुध", "बिही", "शुक्र", "शनि"],
  bsDaysFull: [
    "आइतवार",
    "सोमवार",
    "मंगलवार",
    "बुधवार",
    "बिहिवार",
    "शुक्रवार",
    "शनिवार",
  ],
  nepaliNumbers: ["०", "१", "२", "३", "४", "५", "६", "७", "८", "९"],
  bsMonthUpperDays: [
    [30, 31],
    [31, 32],
    [31, 32],
    [31, 32],
    [31, 32],
    [30, 31],
    [29, 30],
    [29, 30],
    [29, 30],
    [29, 30],
    [29, 30],
    [30, 31],
  ],
  extractedBsMonthData: [
    [
      0, 1, 1, 22, 1, 3, 1, 1, 1, 3, 1, 22, 1, 3, 1, 3, 1, 22, 1, 3, 1, 19, 1,
      3, 1, 1, 3, 1, 2, 2, 1, 3, 1,
    ],
    [
      1, 2, 2, 2, 2, 2, 2, 1, 3, 1, 3, 1, 2, 2, 2, 3, 2, 2, 2, 1, 3, 1, 3, 1, 2,
      2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 3, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1,
      3, 1, 2, 2, 2, 2, 2, 1, 1, 1, 2, 2, 2, 2, 2, 1, 3, 1, 1, 2,
    ],
    [
      0, 1, 2, 1, 3, 1, 3, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 2, 2,
      1, 3, 1, 3, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 3, 1, 3, 1, 2, 2, 2, 2, 2, 2,
      2, 2, 2, 1, 3, 1, 3, 1, 1, 1, 1, 2, 2, 2, 2, 2, 1, 3, 1, 1, 2,
    ],
    [
      1, 2, 1, 3, 1, 3, 1, 3, 1, 3, 1, 3, 1, 3, 1, 3, 1, 3, 1, 3, 1, 3, 1, 3, 1,
      3, 1, 3, 1, 2, 2, 2, 1, 3, 1, 3, 1, 3, 1, 3, 1, 3, 1, 2, 2, 2, 1, 3, 1, 3,
      1, 3, 1, 3, 1, 3, 1, 3, 2, 2, 1, 3, 1, 2, 2, 2, 1, 2,
    ],
    [59, 1, 26, 1, 28, 1, 2, 1, 12],
    [
      0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 3, 1, 3, 1, 3, 1, 2, 2, 2, 2, 2,
      2, 2, 2, 2, 2, 2, 1, 3, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 3, 1, 2, 2,
      2, 2, 2, 2, 2, 2, 2, 2, 5, 1, 1, 2, 2, 1, 3, 1, 2, 1, 2,
    ],
    [
      0, 12, 1, 3, 1, 3, 1, 5, 1, 11, 1, 3, 1, 3, 1, 18, 1, 3, 1, 3, 1, 18, 1,
      3, 1, 3, 1, 27, 1, 2,
    ],
    [
      1, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 3, 1, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2,
      1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
      2, 2, 2, 1, 2, 2, 2, 15, 2, 4,
    ],
    [
      0, 1, 2, 2, 2, 2, 1, 3, 1, 3, 1, 3, 1, 2, 2, 2, 3, 2, 2, 2, 1, 3, 1, 3, 1,
      3, 1, 2, 2, 2, 2, 2, 2, 2, 1, 3, 1, 3, 1, 3, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2,
      1, 3, 1, 3, 1, 2, 2, 2, 15, 2, 4,
    ],
    [
      1, 1, 3, 1, 3, 1, 14, 1, 3, 1, 1, 1, 3, 1, 14, 1, 3, 1, 3, 1, 3, 1, 18, 1,
      3, 1, 3, 1, 3, 1, 14, 1, 3, 15, 1, 2, 1, 1,
    ],
    [
      0, 1, 1, 3, 1, 3, 1, 10, 1, 3, 1, 3, 1, 1, 1, 3, 1, 3, 1, 10, 1, 3, 1, 3,
      1, 3, 1, 3, 1, 14, 1, 3, 1, 3, 1, 3, 1, 3, 1, 10, 1, 20, 1, 1, 1,
    ],
    [
      1, 2, 2, 1, 3, 1, 3, 1, 3, 1, 2, 2, 2, 2, 2, 3, 2, 2, 2, 2, 2, 1, 3, 1, 3,
      1, 3, 1, 2, 2, 2, 2, 2, 2, 2, 1, 3, 1, 3, 1, 3, 1, 3, 1, 2, 2, 2, 2, 2, 2,
      2, 1, 3, 1, 3, 1, 20, 3,
    ],
  ],
  minBsYear: 1970,
  maxBsYear: 2100,
  minAdDateEqBsDate: {
    ad: {
      year: 1913,
      month: 3,
      date: 13,
    },
    bs: {
      year: 1970,
      month: 1,
      date: 1,
    },
  },
};

export const getBsMonthDays = (bsYear: number, bsMonth: number): number => {
  let yearCount = 0;
  const totalYears = bsYear + 1 - calendarData.minBsYear;
  const bsMonthData = calendarData.extractedBsMonthData[bsMonth - 1];

  for (let i = 0; i < bsMonthData.length; i++) {
    if (bsMonthData[i] === 0) continue;

    const bsMonthUpperDaysIndex = i % 2;
    const isError2062 = bsYear === 2062 && (bsMonth === 1 || bsMonth === 2);
    const isError2081 =
      bsYear === 2081 &&
      (bsMonth === 2 || bsMonth === 3 || bsMonth === 12 || bsMonth === 11);
    const bsMonthUpperDaysIndexForError2081 =
      bsMonthUpperDaysIndex === 0 ? 1 : 0;

    yearCount += bsMonthData[i];
    if (totalYears <= yearCount) {
      if (
        (bsYear === 2085 && bsMonth === 5) ||
        (bsYear === 2088 && bsMonth === 5)
      ) {
        return (
          calendarData.bsMonthUpperDays[bsMonth - 1][
            isError2081 || isError2062
              ? bsMonthUpperDaysIndexForError2081
              : bsMonthUpperDaysIndex
          ] - 2
        );
      }
      return calendarData.bsMonthUpperDays[bsMonth - 1][
        isError2081 || isError2062
          ? bsMonthUpperDaysIndexForError2081
          : bsMonthUpperDaysIndex
      ];
    }
  }

  if (bsMonth === 10) {
    return 30;
  }

  return calendarData.bsMonthUpperDays[bsMonth - 1][0];
};

export const toNepaliDigits = (number: number): string => {
  return String(number)
    .split("")
    .map((digit) => calendarData.nepaliNumbers[Number(digit)])
    .join("");
};

const jsDateSymbol = Symbol("jsDate");
const yearSymbol = Symbol("year");
const monthSymbol = Symbol("month");
const daySymbol = Symbol("day");
const dateSymbol = Symbol("date");

export class NepaliDate {
  private [jsDateSymbol]: Date;
  private [yearSymbol]: number;
  private [monthSymbol]: number;
  private [daySymbol]: number;
  private [dateSymbol]: number;

  constructor(year?: number, month?: number, day?: number) {
    const today = new Date();
    const currentBS = this.convertADtoBS(
      today.getFullYear(),
      today.getMonth() + 1,
      today.getDate()
    );

    this[yearSymbol] = year || currentBS.year;
    this[monthSymbol] = month !== undefined ? month : currentBS.month - 1;
    this[daySymbol] = day || currentBS.day;
    this[dateSymbol] = this[daySymbol];
    this[jsDateSymbol] = this.convertBStoAD(
      this[yearSymbol],
      this[monthSymbol] + 1,
      this[daySymbol]
    );
  }

  getDateObject() {
    return {
      year: this[yearSymbol],
      month: this[monthSymbol],
      day: this[daySymbol],
    };
  }

  getBS() {
    return {
      year: this[yearSymbol],
      month: this[monthSymbol] + 1,
      day: this[daySymbol],
    };
  }

  getAD() {
    const adDate = this[jsDateSymbol];
    return {
      year: adDate.getFullYear(),
      month: adDate.getMonth() + 1,
      day: adDate.getDate(),
    };
  }

  setDate(year: number, month: number, day: number) {
    this[yearSymbol] = year;
    this[monthSymbol] = month;
    this[daySymbol] = day;
    this[dateSymbol] = day;
    this[jsDateSymbol] = this.convertBStoAD(year, month + 1, day);
    return this;
  }

  setYear(year: number) {
    return this.setDate(year, this[monthSymbol], this[daySymbol]);
  }

  setMonth(month: number) {
    return this.setDate(this[yearSymbol], month, this[daySymbol]);
  }

  setDay(day: number) {
    return this.setDate(this[yearSymbol], this[monthSymbol], day);
  }

  getYear(): number {
    return this[yearSymbol];
  }

  getMonth(): number {
    return this[monthSymbol];
  }

  getDate(): number {
    return this[dateSymbol];
  }

  getDay(): number {
    return this[jsDateSymbol].getDay();
  }

  format(_formatString: string): string {
    return `${this[yearSymbol]}-${String(this[monthSymbol] + 1).padStart(
      2,
      "0"
    )}-${String(this[daySymbol]).padStart(2, "0")}`;
  }

  toString(): string {
    return this.format("YYYY-MM-DD");
  }

  toJsDate(): Date {
    return this[jsDateSymbol];
  }

  static now(): NepaliDate {
    return new NepaliDate();
  }

  private convertADtoBS(adYear: number, adMonth: number, adDate: number) {
    let bsYear = adYear + 57;
    let bsMonth = (adMonth + 9) % 12;
    bsMonth = bsMonth === 0 ? 12 : bsMonth;
    let bsDate = 1;

    if (adMonth < 4) {
      bsYear -= 1;
    }

    const bsMonthFirstAdDate = this.convertBStoAD(bsYear, bsMonth, 1);
    if (adDate >= 1 && adDate < bsMonthFirstAdDate.getDate()) {
      if (adMonth === 4) {
        const bsYearFirstAdDate = this.convertBStoAD(bsYear, 1, 1);
        if (adDate < bsYearFirstAdDate.getDate()) {
          bsYear -= 1;
        }
      }
      bsMonth = bsMonth !== 1 ? bsMonth - 1 : 12;
      const bsMonthDays = getBsMonthDays(bsYear, bsMonth);
      bsDate = (bsMonthDays || 0) - (bsMonthFirstAdDate.getDate() - adDate) + 1;
    } else {
      bsDate = adDate - bsMonthFirstAdDate.getDate() + 1;
    }

    return { year: bsYear, month: bsMonth, day: bsDate };
  }

  private convertBStoAD(bsYear: number, bsMonth: number, bsDate: number): Date {
    const daysNumFromMinBsYear = this.getTotalDaysNumFromMinBsYear(
      bsYear,
      bsMonth,
      bsDate
    );
    if (daysNumFromMinBsYear === null) return new Date();

    const adDate = new Date(
      calendarData.minAdDateEqBsDate.ad.year,
      calendarData.minAdDateEqBsDate.ad.month - 1,
      calendarData.minAdDateEqBsDate.ad.date - 1
    );
    adDate.setDate(adDate.getDate() + daysNumFromMinBsYear);
    return adDate;
  }

  private getTotalDaysNumFromMinBsYear(
    bsYear: number,
    bsMonth: number,
    bsDate: number
  ): number | null {
    if (bsYear < calendarData.minBsYear || bsYear > calendarData.maxBsYear) {
      return null;
    }

    let daysNumFromMinBsYear = 0;
    const diffYears = bsYear - calendarData.minBsYear;

    for (let month = 1; month <= 12; month++) {
      if (month < bsMonth) {
        daysNumFromMinBsYear += this.getMonthDaysNumFormMinBsYear(
          month,
          diffYears + 1
        );
      } else {
        daysNumFromMinBsYear += this.getMonthDaysNumFormMinBsYear(
          month,
          diffYears
        );
      }
    }

    if (bsYear > 2085 && bsYear < 2088) {
      daysNumFromMinBsYear += bsDate - 2;
    } else if (bsYear === 2085 && bsMonth > 5) {
      daysNumFromMinBsYear += bsDate - 2;
    } else if (bsYear === 2081 && bsMonth === 2) {
      daysNumFromMinBsYear += bsDate;
    } else if (bsYear === 2081 && bsMonth === 3) {
      daysNumFromMinBsYear += bsDate + 1;
    } else if (bsYear === 2081 && bsMonth === 12) {
      daysNumFromMinBsYear += bsDate - 1;
    } else if (bsYear > 2088) {
      daysNumFromMinBsYear += bsDate - 4;
    } else if (bsYear === 2088 && bsMonth > 5) {
      daysNumFromMinBsYear += bsDate - 4;
    } else if (bsYear === 2062 && bsMonth === 2) {
      daysNumFromMinBsYear += bsDate + 1;
    } else {
      daysNumFromMinBsYear += bsDate;
    }

    return daysNumFromMinBsYear;
  }

  private getMonthDaysNumFormMinBsYear(
    bsMonth: number,
    yearDiff: number
  ): number {
    let yearCount = 0;
    let monthDaysFromMinBsYear = 0;
    if (yearDiff === 0) return 0;

    const bsMonthData = calendarData.extractedBsMonthData[bsMonth - 1];
    for (let i = 0; i < bsMonthData.length; i++) {
      if (bsMonthData[i] === 0) continue;

      const bsMonthUpperDaysIndex = i % 2;
      const isError2062 = yearDiff === 2062 && (bsMonth === 1 || bsMonth === 2);
      const isError2081 =
        yearDiff === 2081 &&
        (bsMonth === 2 || bsMonth === 3 || bsMonth === 12 || bsMonth === 11);
      const bsMonthUpperDaysIndexForError2081 =
        bsMonthUpperDaysIndex === 0 ? 1 : 0;

      if (yearDiff > yearCount + bsMonthData[i]) {
        yearCount += bsMonthData[i];
        monthDaysFromMinBsYear +=
          calendarData.bsMonthUpperDays[bsMonth - 1][
            isError2081 || isError2062
              ? bsMonthUpperDaysIndexForError2081
              : bsMonthUpperDaysIndex
          ] * bsMonthData[i];
      } else {
        monthDaysFromMinBsYear +=
          calendarData.bsMonthUpperDays[bsMonth - 1][
            isError2081 || isError2062
              ? bsMonthUpperDaysIndexForError2081
              : bsMonthUpperDaysIndex
          ] *
          (yearDiff - yearCount);
        yearCount = yearDiff - yearCount;
        break;
      }
    }

    return monthDaysFromMinBsYear;
  }
}
